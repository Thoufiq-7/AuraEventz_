<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://kit.fontawesome.com/64d58efce2.js" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/worker_login_register.css') }}" />
    <title>Worker Portal - AuraEventz</title>
</head>
<body>
    <div class="container">
        <div class="forms-container">
            <div class="signin-signup">
                {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                <div style="position: absolute; top: -80px; left: 50%; transform: translateX(-50%); width: 100%; text-align: center; z-index: 100;">
                    {% for category, message in messages %}
                    <div style="padding: 1rem; margin-bottom: 0.5rem; border-radius: 8px; color: #1f2937; background-color: {% if category == 'success' %}#d1fae5{% elif category == 'danger' %}#fee2e2{% else %}#e0e7ff{% endif %};">
                        {{ message }}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                {% endwith %}

                <form action="{{ url_for('worker_login') }}" method="POST" class="sign-in-form" id="worker-sign-in-form">
                    <h2 class="title">Worker Sign in</h2>
                    <div class="input-field">
                        <i class="fas fa-envelope"></i>
                        <input type="email" placeholder="Email" id="signin-email" required />
                    </div>
                    <div class="input-field">
                        <i class="fas fa-lock"></i>
                        <input type="password" placeholder="Password" id="signin-password" required />
                    </div>
                    <input type="submit" value="Login" class="btn solid" />
                    <input type="hidden" name="id_token" id="signin-id-token" />
                </form>

                <form action="{{ url_for('worker_register') }}" method="POST" class="sign-up-form">
                    <h2 class="title">Worker Sign up</h2>
                    <div class="input-field">
                        <i class="fas fa-user"></i>
                        <input type="text" placeholder="Username" name="username" required />
                    </div>
                    <div class="input-field">
                        <i class="fas fa-envelope"></i>
                        <input type="email" placeholder="Email" name="email" required />
                    </div>
                    <div class="input-field">
                        <i class="fas fa-lock"></i>
                        <input type="password" placeholder="Password" name="password" required />
                    </div>
                    <input type="submit" class="btn" value="Sign up" />
                </form>
            </div>
        </div>

        <div class="panels-container">
            <div class="panel left-panel">
                <div class="content">
                    <h3>New Worker here?</h3>
                    <p>
                        Register to find exciting event opportunities and get hired by top managers in the industry!
                    </p>
                    <button class="btn transparent" id="sign-up-btn">Sign up</button>
                </div>
                
            </div>
            <div class="panel right-panel">
                <div class="content">
                    <h3>Already have an account?</h3>
                    <p>
                        Sign in to browse available jobs, manage your applications, and connect with event organizers.
                    </p>
                    <button class="btn transparent" id="sign-in-btn">Sign in</button>
                </div>
                
            </div>
        </div>
    </div>

   <script>
        // --- UI Toggling Logic ---
        const sign_in_btn = document.querySelector("#sign-in-btn");
        const sign_up_btn = document.querySelector("#sign-up-btn");
        const container = document.querySelector(".container");

        sign_up_btn.addEventListener("click", () => {
            container.classList.add("sign-up-mode");
        });
        sign_in_btn.addEventListener("click", () => {
            container.classList.remove("sign-up-mode");
        });

        // --- Firebase Initialization and Authentication ---
        const firebaseConfig = {{ firebase_config | tojson }};
        let auth;

        // --- DEBUGGING ---
        console.log("Attempting to initialize Firebase with config:", firebaseConfig);

        // Check if the config object has the necessary keys
        if (firebaseConfig && firebaseConfig.apiKey) {
            try {
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                console.log("Firebase initialized successfully!");
            } catch (e) {
                console.error("Error initializing Firebase:", e);
                alert("A critical error occurred while initializing the application. Please contact support.");
            }
        } else {
            console.error("FATAL: Firebase configuration is missing or incomplete. Cannot initialize Firebase.");
            // Display a user-friendly error on the page itself
            const signInForm = document.getElementById('worker-sign-in-form');
            const errorDiv = document.createElement('div');
            errorDiv.textContent = 'Configuration Error: The application cannot connect to the authentication service.';
            errorDiv.style.color = 'red';
            errorDiv.style.marginTop = '10px';
            signInForm.prepend(errorDiv);
        }

        // --- Firebase Sign-In Logic ---
        const signInForm = document.getElementById('worker-sign-in-form');
        signInForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!auth) {
                alert("Authentication service is not available due to a configuration error.");
                return;
            }

            const email = document.getElementById('signin-email').value;
            const password = document.getElementById('signin-password').value;
            const idTokenInput = document.getElementById('signin-id-token');
            const submitButton = signInForm.querySelector('.btn.solid');
            
            submitButton.value = 'Logging in...';
            submitButton.disabled = true;

            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const idToken = await userCredential.user.getIdToken();
                idTokenInput.value = idToken;
                signInForm.submit();
            } catch (error) {
                alert(`Login Failed: ${error.message}`);
                submitButton.value = 'Login';
                submitButton.disabled = false;
            }
        });
    </script>
</body>
</html>